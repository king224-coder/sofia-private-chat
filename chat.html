<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sofia Private Chat - Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: white;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    padding: 15px;
    background: #1f1f1f;
    text-align: center;
    font-size: 1.2em;
    border-bottom: 1px solid #333;
  }
  #chatBox {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: #222;
  }
  .message {
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 10px;
    max-width: 70%;
    clear: both;
    position: relative;
    word-wrap: break-word;
  }
  .you {
    background-color: #007bff;
    color: white;
    float: right;
  }
  .friend {
    background-color: #444;
    color: white;
    float: left;
  }
  .delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 0.8em;
  }
  #messageInput {
    display: flex;
    padding: 10px;
    background: #1f1f1f;
    border-top: 1px solid #333;
  }
  #messageInput input {
    flex: 1;
    padding: 10px;
    font-size: 1em;
    border: none;
    border-radius: 5px;
  }
  #messageInput button {
    margin-left: 10px;
    padding: 10px 15px;
    font-size: 1em;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
</style>
</head>
<body>

<header>
  Chatting with <span id="friendName"></span>
</header>

<div id="chatBox">Loading messages...</div>

<div id="messageInput">
  <input type="text" id="message" placeholder="Type your message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MSG_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
  // Get user and friend info from localStorage
  const userStr = localStorage.getItem("mlbbUser");
  if (!userStr) {
    alert("Please login first!");
    window.location.href = "index.html";
    throw new Error("No user in localStorage");
  }
  const user = JSON.parse(userStr);

  const friendId = localStorage.getItem("friendId");
  const friendServer = localStorage.getItem("friendServer");
  if (!friendId || !friendServer) {
    alert("No friend selected! Please select a friend from chat list.");
    window.location.href = "chatlist.html";
    throw new Error("No friend info");
  }

  const currentUserKey = user.mlbbId + "_" + user.serverId;
  const friendKey = friendId + "_" + friendServer;

  // Show friend name
  document.getElementById("friendName").textContent = friendKey;

  const chatBox = document.getElementById("chatBox");
  const messageInput = document.getElementById("message");
  const sendBtn = document.getElementById("sendBtn");

  // Chatroom ID (sorted keys to keep consistent)
  const chatRoomId = [currentUserKey, friendKey].sort().join("_vs_");
  const chatCollectionRef = db.collection("messages").doc(chatRoomId).collection("chat");

  // Load messages realtime
  chatCollectionRef.orderBy("timestamp")
    .onSnapshot(snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");
        messageDiv.classList.add(data.sender === currentUserKey ? "you" : "friend");

        const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleTimeString() : "";

        let innerHTML = `<strong>${data.sender === currentUserKey ? "You" : friendId}</strong><br>`;
        innerHTML += `${data.text}<br>`;
        innerHTML += `<small>${time}</small>`;

        // Show delete button only for your messages
        if (data.sender === currentUserKey) {
          innerHTML += `<button class="delete-btn" data-id="${doc.id}" title="Delete this message">âœ–</button>`;
        }

        messageDiv.innerHTML = innerHTML;
        chatBox.appendChild(messageDiv);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });

  // Delete message
  chatBox.addEventListener("click", async (e) => {
    if (e.target.classList.contains("delete-btn")) {
      const docId = e.target.getAttribute("data-id");
      if (confirm("Delete this message?")) {
        try {
          await chatCollectionRef.doc(docId).delete();
        } catch (err) {
          alert("Failed to delete message: " + err.message);
        }
      }
    }
  });

  // Send message
  sendBtn.addEventListener("click", async () => {
    const text = messageInput.value.trim();
    if (!text) return;

    try {
      await chatCollectionRef.add({
        sender: currentUserKey,
        receiver: friendKey,
        text: text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        participants: [currentUserKey, friendKey]
      });
      messageInput.value = "";
    } catch (err) {
      alert("Failed to send message: " + err.message);
    }
  });

  // Send on Enter key
  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendBtn.click();
  });
</script>

</body>
</html>

