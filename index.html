<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sofia Private Chat - Login</title>
<style>
  body {
    margin: 0; padding: 0;
    font-family: Arial, sans-serif;
    background: #121212;
    color: white;
    display: flex; justify-content: center; align-items: center;
    height: 100vh;
    overflow: hidden;
  }
  .container {
    background: #1e1e1e;
    padding: 25px 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px #000000aa;
    width: 350px;
  }
  h2 {
    margin-bottom: 15px;
    text-align: center;
  }
  input[type="number"], input[type="file"] {
    width: 100%;
    padding: 10px 12px;
    margin: 10px 0;
    border-radius: 6px;
    border: none;
    font-size: 16px;
  }
  button {
    width: 100%;
    background: #4caf50;
    border: none;
    color: white;
    padding: 12px;
    font-size: 18px;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 15px;
  }
  button:hover {
    background: #43a047;
  }
  #profilePreview {
    display: block;
    margin: 10px auto;
    width: 100px; height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #4caf50;
  }
  .hidden {
    display: none;
  }
  .popup-content {
    background: #222;
    padding: 20px 25px;
    border-radius: 12px;
    width: 320px;
    max-width: 90vw;          /* Responsive width */
    max-height: 80vh;         /* Max height so it doesn't overflow */
    overflow-y: auto;         /* Scroll if too tall */
    text-align: center;
    box-shadow: 0 0 25px #000000dd;
    box-sizing: border-box;
  }

  .popup-content input,
  .popup-content button {
    width: 100%;
    box-sizing: border-box;
    margin: 10px 0;
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 16px;
  }

  /* Styles for login info display */
  #loginInfoContainer {
    text-align: center;
    margin-top: 15px;
    color: #ccc;
    width: 350px;
  }
  #showLoginInfoBtn {
    padding: 10px 20px;
    border-radius: 6px;
    background:#007bff;
    color:#fff;
    border:none;
    cursor:pointer;
    margin-top: 10px;
    width: 100%;
    display: block; /* Make sure it's visible by default */
  }
  #showLoginInfoBtn:hover {
    background: #0056b3;
  }
  #loginInfoDetails {
    margin-top: 15px;
    display: none;
  }
  #loginInfoDetails img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 2px solid #4caf50;
    margin-top: 10px;
  }
</style>
</head>
<body>

<div class="container" id="loginContainer">
  <h2>Login to Sofia Chat</h2>
  <input type="number" id="mlbbId" placeholder="Enter your MLBB ID" required />
  <input type="number" id="serverId" placeholder="Enter your Server ID" required />
  <input type="file" id="profilePic" accept="image/*" required />
  <img id="profilePreview" class="hidden" />
  <button id="loginBtn">Login</button>
</div>

<div class="popup hidden" id="friendPopup">
  <div class="popup-content">
    <h3>Add Friend to Chat</h3>
    <input type="number" id="friendMlbbId" placeholder="Friend's MLBB ID" required />
    <input type="number" id="friendServerId" placeholder="Friend's Server ID" required />
    <button id="startChatBtn">Start Chatting</button>
  </div>
</div>

<!-- Login Info container -->
<div id="loginInfoContainer" class="hidden">
  <button id="showLoginInfoBtn">Show Login Info</button>
  <div id="loginInfoDetails">
    <p><strong>MLBB ID:</strong> <span id="infoMlbbId"></span></p>
    <p><strong>Server ID:</strong> <span id="infoServerId"></span></p>
    <img id="infoProfilePic" alt="Profile Picture" />
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBrrtZUDzER0acEggVlwhfL_JV5gMkmfjw",
    authDomain: "sofiaprivatechat-bfa0e.firebaseapp.com",
    projectId: "sofiaprivatechat-bfa0e",
    storageBucket: "sofiaprivatechat-bfa0e.appspot.com",
    messagingSenderId: "475737605844",
    appId: "1:475737605844:web:4ab5640b8c822715259d41"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const loginContainer = document.getElementById("loginContainer");
  const loginBtn = document.getElementById("loginBtn");
  const profilePicInput = document.getElementById("profilePic");
  const profilePreview = document.getElementById("profilePreview");

  const friendPopup = document.getElementById("friendPopup");
  const startChatBtn = document.getElementById("startChatBtn");

  const loginInfoContainer = document.getElementById("loginInfoContainer");
  const showLoginInfoBtn = document.getElementById("showLoginInfoBtn");
  const loginInfoDetails = document.getElementById("loginInfoDetails");
  const infoMlbbId = document.getElementById("infoMlbbId");
  const infoServerId = document.getElementById("infoServerId");
  const infoProfilePic = document.getElementById("infoProfilePic");

  // Show preview of profile pic
  profilePicInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) {
      profilePreview.src = URL.createObjectURL(file);
      profilePreview.classList.remove("hidden");
    } else {
      profilePreview.classList.add("hidden");
      profilePreview.src = "";
    }
  });

  // Check if user already logged in
  window.onload = () => {
    const mlbbId = localStorage.getItem("mlbbId");
    const serverId = localStorage.getItem("serverId");
    const profilePic = localStorage.getItem("profilePic");

    if (mlbbId && serverId && profilePic) {
      showFriendPopup();
      loginContainer.classList.add("hidden");
      loginInfoContainer.classList.remove("hidden");
      showLoginInfoBtn.style.display = "block"; // Show button when user info exists
      loginInfoDetails.style.display = "none";   // Hide details initially
    } else {
      loginInfoContainer.classList.add("hidden");
      showLoginInfoBtn.style.display = "none";  // Hide button if no info
    }
  };

  loginBtn.addEventListener("click", async () => {
    const mlbbId = document.getElementById("mlbbId").value.trim();
    const serverId = document.getElementById("serverId").value.trim();
    const profilePicFile = profilePicInput.files[0];

    if (!mlbbId || !serverId || !profilePicFile) {
      alert("Please fill all login fields and upload a profile picture.");
      return;
    }

    // Check uniqueness of MLBB ID + Server ID in Firestore
    try {
      const usersRef = collection(db, "users");
      const q = query(usersRef, where("mlbbId", "==", mlbbId), where("serverId", "==", serverId));
      const querySnapshot = await getDocs(q);
      if (!querySnapshot.empty) {
        alert("This MLBB ID and Server ID is already registered. Please use your own unique ID.");
        return;
      }
    } catch (err) {
      alert("Error checking ID uniqueness: " + err.message);
      return;
    }

    // Read profile picture as base64
    const reader = new FileReader();
    reader.onloadend = () => {
      const base64Pic = reader.result;
      // Save user info in localStorage permanently
      localStorage.setItem("mlbbId", mlbbId);
      localStorage.setItem("serverId", serverId);
      localStorage.setItem("profilePic", base64Pic);

      // Save user to Firestore users collection for uniqueness checking
      saveUserToFirestore(mlbbId, serverId, base64Pic);

      alert("Login successful!");
      showFriendPopup();
      loginContainer.classList.add("hidden");
      loginInfoContainer.classList.remove("hidden");
      showLoginInfoBtn.style.display = "block";  // Show login info button
      loginInfoDetails.style.display = "none";    // Hide details initially
    };
    reader.readAsDataURL(profilePicFile);
  });

  async function saveUserToFirestore(mlbbId, serverId, base64Pic) {
    try {
      const usersRef = collection(db, "users");
      await usersRef.add({
        mlbbId: mlbbId,
        serverId: serverId,
        profilePic: base64Pic,
        timestamp: new Date()
      });
    } catch (err) {
      console.error("Error saving user info:", err);
    }
  }

  // Show friend popup
  function showFriendPopup() {
    friendPopup.classList.remove("hidden");
  }

  // Start chat button click
  startChatBtn.addEventListener("click", () => {
    const friendMlbbId = document.getElementById("friendMlbbId").value.trim();
    const friendServerId = document.getElementById("friendServerId").value.trim();

    if (!friendMlbbId || !friendServerId) {
      alert("Please enter your friend's MLBB ID and Server ID.");
      return;
    }

    // Save friend info locally to use in chat page
    localStorage.setItem("friendId", friendMlbbId);
    localStorage.setItem("friendServer", friendServerId);

    // Redirect to chat page
    window.location.href = "chat.html";
  });

  // Show/hide login info details toggle
  showLoginInfoBtn.addEventListener("click", () => {
    if (loginInfoDetails.style.display === "none" || loginInfoDetails.style.display === "") {
      infoMlbbId.textContent = localStorage.getItem("mlbbId");
      infoServerId.textContent = localStorage.getItem("serverId");
      infoProfilePic.src = localStorage.getItem("profilePic");
      loginInfoDetails.style.display = "block";
      showLoginInfoBtn.textContent = "Hide Login Info";
    } else {
      loginInfoDetails.style.display = "none";
      showLoginInfoBtn.textContent = "Show Login Info";
    }
  });
</script>

</body>
</html>