<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sofia Private Chat - Friends</title>
<style>
  body {
    margin: 0; font-family: 'Segoe UI', sans-serif;
    background: #0d0d0d; color: white;
    display: flex; flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: #1a1a1a; padding: 15px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #333;
  }
  #myProfile {
    display: flex; align-items: center; gap: 15px;
  }
  #myProfile img {
    width: 50px; height: 50px; border-radius: 50%; border: 2px solid #007bff;
  }
  #myProfile div {
    font-weight: bold; font-size: 1.1em;
  }
  #logoutBtn {
    background: #dc3545; border: none; color: white;
    padding: 8px 12px; border-radius: 6px; cursor: pointer;
  }
  main {
    flex: 1; overflow-y: auto; padding: 15px;
  }
  section {
    margin-bottom: 25px;
  }
  h3 {
    border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 10px;
  }
  .friend-list, .request-list {
    list-style: none; padding: 0; margin: 0;
  }
  .friend-list li, .request-list li {
    background: #222; margin-bottom: 10px;
    padding: 10px; border-radius: 10px;
    display: flex; align-items: center; justify-content: space-between;
    cursor: pointer;
  }
  .friend-info {
    display: flex; align-items: center; gap: 15px;
  }
  .friend-info img {
    width: 40px; height: 40px; border-radius: 50%;
    border: 2px solid #007bff;
  }
  .friend-info div {
    display: flex; flex-direction: column;
  }
  .btn-accept, .btn-reject {
    border: none; border-radius: 6px; padding: 6px 10px;
    cursor: pointer; color: white; font-weight: bold;
  }
  .btn-accept {
    background: #28a745;
    margin-right: 8px;
  }
  .btn-reject {
    background: #dc3545;
  }
  #addFriendForm {
    display: flex; gap: 10px; flex-wrap: wrap;
    margin-top: 10px;
  }
  #addFriendForm input {
    flex: 1; min-width: 120px;
    padding: 10px; border-radius: 6px;
    border: none; font-size: 1em;
    background: #222; color: white;
  }
  #addFriendBtn {
    background: #007bff; border: none;
    padding: 10px 15px; border-radius: 6px;
    color: white; cursor: pointer;
  }
  #errorMsg {
    color: #ff5555; margin-top: 10px;
  }
</style>
</head>
<body>

<header>
  <div id="myProfile">
    <img id="myProfilePic" src="" alt="Your Profile Pic" />
    <div>
      <div id="myId"></div>
      <div style="font-size:0.85em; color:#aaa;">(Your MLBB ID & Server)</div>
    </div>
  </div>
  <button id="logoutBtn">Logout</button>
</header>

<main>
  <section>
    <h3>Friend Requests</h3>
    <ul class="request-list" id="requestList">
      <li>No requests</li>
    </ul>
  </section>

  <section>
    <h3>Your Friends</h3>
    <ul class="friend-list" id="friendList">
      <li>No friends yet</li>
    </ul>
  </section>

  <section>
    <h3>Add Friend</h3>
    <form id="addFriendForm">
      <input type="text" id="friendIdInput" placeholder="Friend's MLBB ID" required />
      <input type="text" id="friendServerInput" placeholder="Friend's Server ID" required />
      <button type="submit" id="addFriendBtn">Send Request</button>
    </form>
    <div id="errorMsg"></div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBrrtZUDzER0acEggVlwhfL_JV5gMkmfjw",
    authDomain: "sofiaprivatechat-bfa0e.firebaseapp.com",
    projectId: "sofiaprivatechat-bfa0e",
    storageBucket: "sofiaprivatechat-bfa0e.appspot.com",
    messagingSenderId: "475737605844",
    appId: "1:475737605844:web:4ab5640b8c822715259d41"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Get current user info from localStorage
  const playerId = localStorage.getItem("playerId");
  const playerServer = localStorage.getItem("playerServer");
  const profileBase64 = localStorage.getItem("profile");
  const userKey = `${playerId}_${playerServer}`;

  const myProfilePic = document.getElementById("myProfilePic");
  const myIdDiv = document.getElementById("myId");
  const logoutBtn = document.getElementById("logoutBtn");

  const friendListElem = document.getElementById("friendList");
  const requestListElem = document.getElementById("requestList");
  const addFriendForm = document.getElementById("addFriendForm");
  const friendIdInput = document.getElementById("friendIdInput");
  const friendServerInput = document.getElementById("friendServerInput");
  const errorMsg = document.getElementById("errorMsg");

  if (!playerId || !playerServer || !profileBase64) {
    alert("⚠ Not logged in. Redirecting to login page.");
    window.location.href = "index.html";
  } else {
    myProfilePic.src = profileBase64;
    myIdDiv.textContent = `${playerId} (Server ${playerServer})`;
  }

  logoutBtn.onclick = () => {
    localStorage.clear();
    window.location.href = "index.html";
  };

  // Utility to get user document
  async function getUserDoc(userKey) {
    const docRef = doc(db, "users", userKey);
    const docSnap = await getDoc(docRef);
    return docSnap.exists() ? docSnap.data() : null;
  }

  // Refresh friend requests & friends UI
  async function refreshUI() {
    const meDocRef = doc(db, "users", userKey);
    const meDocSnap = await getDoc(meDocRef);
    if (!meDocSnap.exists()) {
      alert("User data missing. Please login again.");
      localStorage.clear();
      window.location.href = "index.html";
      return;
    }
    const meData = meDocSnap.data();

    // Show friend requests
    const requests = meData.requests || [];
    if (requests.length === 0) {
      requestListElem.innerHTML = "<li>No requests</li>";
    } else {
      requestListElem.innerHTML = "";
      for (const req of requests) {
        // Show request sender data (fetch profile pic from users)
        const senderDoc = await getUserDoc(`${req.fromId}_${req.fromServer}`);
        const li = document.createElement("li");
        li.style.cursor = "default";

        const friendInfoDiv = document.createElement("div");
        friendInfoDiv.classList.add("friend-info");

        const img = document.createElement("img");
        img.src = senderDoc?.profilePic || "https://via.placeholder.com/40?text=No+Pic";

        const nameDiv = document.createElement("div");
        nameDiv.textContent = `${req.fromId} (Server ${req.fromServer})`;

        friendInfoDiv.appendChild(img);
        friendInfoDiv.appendChild(nameDiv);

        li.appendChild(friendInfoDiv);

        // Accept and Reject buttons
        const btnAccept = document.createElement("button");
        btnAccept.className = "btn-accept";
        btnAccept.textContent = "Accept";
        btnAccept.onclick = () => acceptRequest(req.fromId, req.fromServer);

        const btnReject = document.createElement("button");
        btnReject.className = "btn-reject";
        btnReject.textContent = "Reject";
        btnReject.onclick = () => rejectRequest(req.fromId, req.fromServer);

        const btnWrapper = document.createElement("div");
        btnWrapper.appendChild(btnAccept);
        btnWrapper.appendChild(btnReject);

        li.appendChild(btnWrapper);
        requestListElem.appendChild(li);
      }
    }

    // Show friends list
    const friends = meData.friends || [];
    if (friends.length === 0) {
      friendListElem.innerHTML = "<li>No friends yet</li>";
    } else {
      friendListElem.innerHTML = "";
      friends.forEach(f => {
        const li = document.createElement("li");

        const friendInfoDiv = document.createElement("div");
        friendInfoDiv.classList.add("friend-info");

        const img = document.createElement("img");
        img.src = f.profilePic || "https://via.placeholder.com/40?text=No+Pic";

        const nameDiv = document.createElement("div");
        nameDiv.textContent = `${f.mlbbId} (Server ${f.serverId})`;

        friendInfoDiv.appendChild(img);
        friendInfoDiv.appendChild(nameDiv);

        li.appendChild(friendInfoDiv);

        li.onclick = () => {
          // Open chat with friend, pass friend's key as query param
          window.location.href = `chat.html?friend=${f.mlbbId}_${f.serverId}`;
        };

        friendListElem.appendChild(li);
      });
    }
  }

  // Accept friend request
  async function acceptRequest(fromId, fromServer) {
    const meDocRef = doc(db, "users", userKey);
    const senderKey = `${fromId}_${fromServer}`;
    const senderDocRef = doc(db, "users", senderKey);

    // Get sender's data
    const senderSnap = await getDoc(senderDocRef);
    if (!senderSnap.exists()) {
      alert("Sender user data not found.");
      return;
    }
    const senderData = senderSnap.data();

    // Update my doc: remove from requests, add to friends
    await updateDoc(meDocRef, {
      requests: arrayRemove({ fromId, fromServer }),
      friends: arrayUnion({
        mlbbId: fromId,
        serverId: fromServer,
        profilePic: senderData.profilePic || ""
      })
    });

    // Update sender doc: add me to their friends
    await updateDoc(senderDocRef, {
      friends: arrayUnion({
        mlbbId: playerId,
        serverId: playerServer,
        profilePic: profileBase64
      })
    });

    await refreshUI();
  }

  // Reject friend request
  async function rejectRequest(fromId, fromServer) {
    const meDocRef = doc(db, "users", userKey);
    await updateDoc(meDocRef, {
      requests: arrayRemove({ fromId, fromServer })
    });
    await refreshUI();
  }

  // Send friend request
  addFriendForm.onsubmit = async (e) => {
    e.preventDefault();
    errorMsg.textContent = "";

    const friendId = friendIdInput.value.trim();
    const friendServer = friendServerInput.value.trim();

    if (!friendId || !friendServer) {
      errorMsg.textContent = "⚠ Please enter friend's MLBB ID and Server ID.";
      return;
    }

    if (friendId === playerId && friendServer === playerServer) {
      errorMsg.textContent = "⚠ You cannot add yourself.";
      return;
    }

    const friendKey = `${friendId}_${friendServer}`;
    const friendDocRef = doc(db, "users", friendKey);
    const friendSnap = await getDoc(friendDocRef);

    if (!friendSnap.exists()) {
      errorMsg.textContent = "⚠ Friend not found.";
      return;
    }

    // Check if already friends or request sent
    const meDocRef = doc(db, "users", userKey);
    const meSnap = await getDoc(meDocRef);
    const meData = meSnap.data();

    const alreadyFriend = (meData.friends || []).some(f => f.mlbbId === friendId && f.serverId === friendServer);
    if (alreadyFriend) {
      errorMsg.textContent = "⚠ This user is already your friend.";
      return;
    }

    const requestAlreadySent = (friendSnap.data().requests || []).some(r => r.fromId === playerId && r.fromServer === playerServer);
    if (requestAlreadySent) {
      errorMsg.textContent = "⚠ Friend request already sent.";
      return;
    }

    // Add request to friend's requests array
    await updateDoc(friendDocRef, {
      requests: arrayUnion({ fromId: playerId, fromServer: playerServer })
    });

    friendIdInput.value = "";
    friendServerInput.value = "";
    errorMsg.style.color = "#00ff00";
    errorMsg.textContent = "✅ Friend request sent!";
    setTimeout(() => errorMsg.textContent = "", 3000);
  };

  // Initial UI refresh
  refreshUI();

  // Listen to real-time updates on user's doc and refresh UI automatically
  const userDocRef = doc(db, "users", userKey);
  onSnapshot(userDocRef, () => {
    refreshUI();
  });

</script>

</body>
</html>
