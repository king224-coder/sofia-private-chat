<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sofia Private Chat - Chat List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }
    .header {
      background: #ff5ca4;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    }
    .profile {
      display: flex;
      align-items: center;
      padding: 10px;
      background: white;
      border-bottom: 1px solid #ccc;
    }
    .profile img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-right: 15px;
    }
    .chat-list {
      padding: 10px;
      min-height: 200px;
    }
    .chat-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .chat-item:hover {
      background: #ffe4f0;
    }
    .loading {
      text-align: center;
      margin-top: 50px;
      font-size: 20px;
      color: #aaa;
    }
    .add-friend {
      margin: 10px;
      background: #ff5ca4;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      width: calc(100% - 20px);
    }
  </style>
</head>
<body>

  <div class="header">Sofia Private Chat</div>

  <div class="profile" id="profileSection">
    <img id="userPic" src="" alt="Profile" />
    <div>
      <div id="userName">Loading...</div>
      <div id="userID"></div>
    </div>
  </div>

  <button class="add-friend" id="addFriendBtn">Add New Friend</button>

  <div class="chat-list" id="chatList">
    <div class="loading">Loading chats...</div>
  </div>

  <!-- Load Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

  <!-- Load your Firebase config -->
  <script src="firebase-config.js"></script>

  <script>
    const playerId = localStorage.getItem("playerId");
    const playerServer = localStorage.getItem("playerServer");
    const profilePic = localStorage.getItem("profilePic");

    if (!playerId || !playerServer || !profilePic) {
      alert("Please login first");
      window.location.href = "index.html";
    }

    // Show logged-in user info
    document.getElementById("userPic").src = profilePic;
    document.getElementById("userName").textContent = `Player ID: ${playerId}`;
    document.getElementById("userID").textContent = `Server: ${playerServer}`;

    const chatListDiv = document.getElementById("chatList");
    const currentPlayerKey = `${playerId}_${playerServer}`;

    // Load chat rooms where current user is participant
    async function loadChats() {
      chatListDiv.innerHTML = '<div class="loading">Loading chats...</div>';

      try {
        const snapshot = await db.collection("messages")
          .where("participants", "array-contains", currentPlayerKey)
          .orderBy("timestamp", "desc")
          .get();

        chatListDiv.innerHTML = "";

        if (snapshot.empty) {
          chatListDiv.innerHTML = '<div class="loading">No chats yet</div>';
          return;
        }

        let added = new Set();

        snapshot.forEach(doc => {
          const data = doc.data();
          const participants = data.participants || [];

          if (!participants.includes(currentPlayerKey)) return;

          // Find friend key (other participant)
          const friendKey = participants.find(p => p !== currentPlayerKey);
          if (!friendKey || added.has(friendKey)) return;

          added.add(friendKey);
          const [friendId, friendServer] = friendKey.split("_");

          const div = document.createElement("div");
          div.className = "chat-item";
          div.innerHTML = `
            <strong>Friend ID:</strong> ${friendId}<br/>
            <strong>Server:</strong> ${friendServer}<br/>
            <em>${data.lastMessage || "No messages yet"}</em>
          `;

          div.onclick = () => {
            localStorage.setItem("friendId", friendId);
            localStorage.setItem("friendServer", friendServer);
            window.location.href = "chat.html";
          };

          chatListDiv.appendChild(div);
        });
      } catch (err) {
        console.error("Error loading chats:", err);
        chatListDiv.innerHTML = '<div class="loading">Failed to load chats</div>';
      }
    }

    loadChats();

    // Add friend button logic
    document.getElementById("addFriendBtn").onclick = async () => {
      const newFriendId = prompt("Enter Friend's MLBB ID:");
      if (!newFriendId) return alert("Friend ID cannot be empty");

      const newFriendServer = prompt("Enter Friend's Server ID:");
      if (!newFriendServer) return alert("Friend Server ID cannot be empty");

      const friendKey = `${newFriendId}_${newFriendServer}`;

      if (friendKey === currentPlayerKey) {
        alert("You cannot add yourself as a friend!");
        return;
      }

      try {
        // Check if friend exists in 'users' collection
        const friendDoc = await db.collection("users").doc(friendKey).get();

        if (!friendDoc.exists) {
          alert("Friend not found or not registered in the app.");
          return;
        }

        // Create or update chat doc
        const chatRoomId = [currentPlayerKey, friendKey].sort().join("_vs_");
        const chatDocRef = db.collection("messages").doc(chatRoomId);

        const chatDoc = await chatDocRef.get();

        if (!chatDoc.exists) {
          await chatDocRef.set({
            participants: [currentPlayerKey, friendKey],
            lastMessage: "",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert("Friend added successfully! You can now chat.");
        } else {
          alert("Friend is already in your chat list.");
        }

        loadChats(); // refresh chat list
      } catch (error) {
        alert("Failed to add friend: " + error.message);
      }
    };
  </script>

</body>
</html>